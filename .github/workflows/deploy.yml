name: CI/CD Pipeline
on:
  push:
    branches: ["master", "frontend-work" ]  
  pull_request:
    branches: [ "master", "frontend-work" ]
  workflow_dispatch:  

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 10  
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Debug - Show current branch
        run: |
          echo "Current branch: ${{ github.ref }}"
          echo "Branch name: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          
      - name: Debug - List files
        run: |
          echo "= Root directory ="
          ls -la
          echo -e "\n= Looking for frontend ="
          if [ -d "frontend" ]; then
            echo "Found frontend folder!"
            ls -la frontend/
          else
            echo "No frontend folder found"
          fi
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: Build React Frontend
        run: |
          echo "ðŸ“¦ Building React application..."
          
          # Try multiple possible locations
          if [ -f "frontend/package.json" ]; then
            echo "Found React in frontend/ folder"
            cd frontend
            npm ci
            npm run build
          elif [ -f "package.json" ]; then
            echo "Found React in root folder"
            npm ci
            npm run build || echo " No build script in root, checking for create-react-app"
          else
            echo "ERROR: No package.json found"
            echo "Available files:"
            find . -name "*.json" -type f | head -10
            exit 1
          fi
          
      - name: Verify Build Output
        run: |
          echo "Checking build output..."
          if [ -d "frontend/build" ]; then
            echo "Build created at frontend/build/"
            ls -la frontend/build/
          elif [ -d "build" ]; then
            echo " Build created at build/"
            ls -la build/
          else
            echo "No build folder found - maybe build step failed?"
          fi
        
      - name: Run Tests (Optional)
        run: |
          echo "Running tests..."
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm test -- --watchAll=false --passWithNoTests || echo "Tests may have failed or not exist"
          else
            npm test -- --watchAll=false --passWithNoTests 2>/dev/null || echo "No tests found"
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: build-frontend
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Build for Deployment
        run: |
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm ci
            npm run build
          else
            npm ci
            npm run build
          fi
          
      - name: Deploy to GitHub Pages (Example)
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/build  # or ./build
