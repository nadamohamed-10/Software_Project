name: Backend API Testing (Windows)

on: [push, pull_request]

jobs:
  test-backend:
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test environment
      shell: pwsh
      run: |
        "DATABASE_URL=sqlite::memory:" | Out-File .env.test -Encoding utf8
        "JWT_SECRET=test_jwt_secret_123" | Out-File .env.test -Append
        "NODE_ENV=test" | Out-File .env.test -Append
        "PORT=3000" | Out-File .env.test -Append

    - name: Run database migrations (safe)
      shell: pwsh
      run: |
        $scripts = npm run | Out-String
        if ($scripts -match "migrate") {
          Write-Host "Running migrations..."
          npm run migrate
        } else {
          Write-Host "No migration script found, skipping..."
        }

    - name: Start backend server
      shell: pwsh
      run: |
        Start-Process npm -ArgumentList "start" -PassThru | ForEach-Object {
          $_.Id | Out-File server.pid
        }

        Start-Sleep -Seconds 15
        Write-Host "Checking server..."

        try {
          Invoke-WebRequest http://localhost:3000/api/health -UseBasicParsing
          Write-Host "Server is running"
        } catch {
          Write-Host "Server did not respond yet"
        }

    - name: Run API tests
      shell: pwsh
      run: |
        Write-Host "Running API tests..."

        Write-Host "Health endpoint"
        curl.exe http://localhost:3000/api/health

        Write-Host "Register endpoint"
        curl.exe -X POST http://localhost:3000/api/auth/register `
          -H "Content-Type: application/json" `
          -d "{ `"email`":`"test@example.com`",`"password`":`"test123`",`"firstName`":`"Test`",`"lastName`":`"User`",`"role`":`"Patient`" }"

        Write-Host "Login endpoint"
        curl.exe -X POST http://localhost:3000/api/auth/login `
          -H "Content-Type: application/json" `
          -d "{ `"email`":`"test@example.com`",`"password`":`"test123`" }"

        Write-Host "ðŸŽ¯ API tests completed"

    - name: Run Postman tests
      shell: pwsh
      run: |
        npm install -g newman

        @'
        {
          "info": {
            "name": "Clinic API Tests",
            "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
          },
          "item": [
            {
              "name": "Health Check",
              "request": {
                "method": "GET",
                "url": "http://localhost:3000/api/health"
              }
            }
          ]
        }
        '@ | Out-File postman-tests.json -Encoding utf8

        newman run postman-tests.json --reporters cli

    - name: Stop server
      if: always()
      shell: pwsh
      run: |
        if (Test-Path server.pid) {
          $pid = Get-Content server.pid
          Stop-Process -Id $pid -Force
        }
        Write-Host "âœ… CI/CD Pipeline completed successfully"

