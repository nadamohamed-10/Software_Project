name: Backend API Testing

on: [push, pull_request]

jobs:
  test-backend:
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test environment
      shell: pwsh
      run: |
        "DATABASE_URL=sqlite:test.db" | Out-File .env.test
        "JWT_SECRET=test_secret" | Out-File .env.test -Append
        "NODE_ENV=test" | Out-File .env.test -Append
        "PORT=3000" | Out-File .env.test -Append

    - name: Run database migrations
      shell: pwsh
      run: |
        npm run migrate || npx sequelize-cli db:migrate

    - name: Start backend server
      shell: pwsh
      run: |
        Start-Process npm "start"
        Start-Sleep -Seconds 20

    - name: Health check
      shell: pwsh
      run: |
        Invoke-WebRequest http://localhost:3000/api/health -ErrorAction Stop

    - name: Test Register API
      shell: pwsh
      run: |
        $body = @{
          email="ci@test.com"
          password="test123"
          firstName="CI"
          lastName="User"
        } | ConvertTo-Json

        Invoke-RestMethod `
          -Uri http://localhost:3000/api/auth/register `
          -Method POST `
          -ContentType application/json `
          -Body $body `
          -ErrorAction Stop

    - name: Test Login API
      shell: pwsh
      run: |
        $body = @{
          email="ci@test.com"
          password="test123"
        } | ConvertTo-Json

        Invoke-RestMethod `
          -Uri http://localhost:3000/api/auth/login `
          -Method POST `
          -ContentType application/json `
          -Body $body `
          -ErrorAction Stop

    - name: Stop server
      if: always()
      shell: pwsh
      run: |
        Get-Process node -ErrorAction SilentlyContinue | Stop-Process -Force
